filter {
  json {
    source_field: "message"
    on_error: "json_parse_failed"
  }

  # --- Ensure 'properties' exists ---
  if !has(properties) {
    properties = {}
  }

  # --- Product Event Type ---
  if has(category) && category != "" {
    metadata.product_event_type = category
  } else if has(operationName) && operationName != "" {
    metadata.product_event_type = operationName
  } else if has(properties.EventType) && properties.EventType != "" {
    metadata.product_event_type = properties.EventType
  } else {
    metadata.product_event_type = "unknown_event_type"
  }

  # --- Recipient Email Address ---
  if has(properties.RecipientEmailAddress) && properties.RecipientEmailAddress != "" {
    event.network.email.to = [properties.RecipientEmailAddress]
  }

  # --- Sender Email Address ---
  if has(properties.SenderFromAddress) && properties.SenderFromAddress != "" {
    event.network.email.from = properties.SenderFromAddress
  }

  # --- Sender Display Name ---
  if has(properties.SenderDisplayName) && properties.SenderDisplayName != "" {
    event.actor.user.display_name = properties.SenderDisplayName
  }

  # --- File Name ---
  if has(properties.FileName) && properties.FileName != "" {
    event.target.file.name = properties.FileName
  }

  # --- File Type ---
  if has(properties.FileType) && properties.FileType != "" {
    event.target.file.mime_type = properties.FileType
  }

  # --- SHA256 Extraction ---
  if has(properties.SHA256) && properties.SHA256 != "" {
    event.target.file.sha256 = properties.SHA256
  } else if has(properties.FileSha256) && properties.FileSha256 != "" {
    event.target.file.sha256 = properties.FileSha256
  } else if has(properties.AttachmentSha256) && properties.AttachmentSha256 != "" {
    event.target.file.sha256 = properties.AttachmentSha256
  }

  # --- File Size ---
  if has(properties.FileSize) {
    event.target.file.size = properties.FileSize
  }

  # --- Threat Information ---
  if has(properties.ThreatTypes) && properties.ThreatTypes != "" {
    event.security_result.threat_type = properties.ThreatTypes
  }
  if has(properties.ThreatNames) && properties.ThreatNames != "" {
    event.security_result.threat_name = properties.ThreatNames
  }
  if has(properties.DetectionMethods) && properties.DetectionMethods != "" {
    event.security_result.detection_method = properties.DetectionMethods
  }

  # --- Report ID ---
  if has(properties.ReportId) && properties.ReportId != "" {
    event.additional.fields.ReportId = properties.ReportId
  }

  # --- Timestamp ---
  if has(properties.Timestamp) && properties.Timestamp != "" {
    metadata.event_timestamp = properties.Timestamp
  }

  # --- Tenant ---
  if has(Tenant) && Tenant != "" {
    metadata.tenant_name = Tenant
  }

  # --- Default Success ---
  metadata.event_parsing_status = "success"
}
